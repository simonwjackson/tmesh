#!/usr/bin/env bash

TMUX="${TMUX:-}"
TERM="${TERM:-}"
TMESH_SOCKET="${TMESH_SOCKET:-tmesh}"
SERVER="${SERVER:=$(hostname)}"
CMD='nvim -c \"autocmd TermClose * if !v:event.status | quit | endif\" +terminal'
TMESH_DEFAULT_CONFIG='
# Server options
set -as terminal-features ',tmux-256color:clipboard'
set -g default-terminal "tmux-256color"
set -g history-limit 50000
set -g status-interval 5
set -g focus-events on

# Window options  
setw -g aggressive-resize on
setw -g mode-keys vi

# Disable all the status bar stuff
set -g status off
'

function tryStartTmeshServerSession() {
  mosh "$SERVER" -- sh -c "nix run nixpkgs#tmux -- -f <(echo -n \$'$TMESH_DEFAULT_CONFIG') -L ${TMESH_SOCKET}-server new-session -s default -d \"$CMD\"" >/dev/null 2>&1
}

function tryStartTmeshClientSession() {
  tmux \
    -f <(
      cat <<EOF
$TMESH_DEFAULT_CONFIG
EOF
    ) \
    -L "$TMESH_SOCKET" \
    new-session \
    -s "$SERVER" \
    -d \
    mosh "$SERVER" -- sh -c "nix run nixpkgs#tmux -- -L ${TMESH_SOCKET}-server attach-session -t default" >/dev/null 2>&1
}

tryStartTmesh() {
  # Check if tmesh server session exists
  if ! tmux -L "$TMESH_SOCKET" has-session -t "$SERVER" 2>/dev/null; then
    [[ "${DEBUG:-0}" == "1" ]] && echo "DEBUG: Starting tmesh session" 1>&2

    tryStartTmeshServerSession
    tryStartTmeshClientSession

  else
    [[ "${DEBUG:-0}" == "1" ]] && echo "DEBUG: Session already exists" 1>&2
  fi
}

tryConnectTmux() {
  tmux -L "$TMESH_SOCKET" attach-session -d -t "$SERVER"
  # if [[ -z "$TMUX" ]]; then
  #   tmux -L "$TMESH_SOCKET" attach-session -t "$SERVER"
  # else
  #   tmux -L "$TMESH_SOCKET" switch-client -t "$SERVER"
  # fi
}

main() {
  tryStartTmesh
  tryConnectTmux
}

main
