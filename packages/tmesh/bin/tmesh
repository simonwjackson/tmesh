#!/usr/bin/env bash

TMUX="${TMUX:-}"
TERM="${TERM:-}"
TMESH_SOCKET="${TMESH_SOCKET:-tmesh}"
SERVER="${TMESH_SERVER:=$(hostname)}"
CMD="${TMESH_CMD:-${SHELL:-/bin/sh}}"
TMESH_DEBUG="${TMESH_DEBUG:-}"
NIX_BIN="${NIX_BIN:-$(command -v nix || echo /run/current-system/sw/bin/nix)}"

# Helper function to conditionally suppress output
suppress_output() {
  if [[ -n "$TMESH_DEBUG" ]]; then
    "$@"
  else
    "$@" >/dev/null 2>&1
  fi
}
TMESH_BASE_CONFIG='
# INFO: https://github.com/tmux/tmux/wiki/Clipboard#terminal-support---tmux-inside-tmux
set -s set-clipboard on

# allow passthrough of escape sequences
set -g allow-passthrough on
set -g status off

# Switch to another session if last window closed
set-option -g detach-on-destroy off

# Disable right click menu
unbind-key -T root MouseDown3Pane

# Respond to focus events
set-option -g focus-events on

# address vim mode switching delay (http://superuser.com/a/252717/65504)
set-option -s escape-time 0

# silent
set-option -g visual-activity off
set-option -g visual-bell off
set-option -g visual-silence off
set-option -g bell-action none

# Ignore window notifications
set-window-option -g monitor-activity off
# Auto resize to the latest window
set-option -g window-size latest

# Server options
set -g default-terminal "tmux-256color"
set -sa terminal-features ',xterm-256color:RGB'

# Enable 24-bit true color support
set -ga terminal-overrides ",*256col*:Tc"
set -g history-limit 50000

# Window options  
setw -g aggressive-resize on
setw -g mode-keys vi

# Disable all the status bar stuff
set -g status off
'

function isLocalhost() {
  local server="$1"
  local current_hostname
  current_hostname=$(hostname)
  
  # Check various localhost representations
  [[ "$server" == "localhost" ]] || \
  [[ "$server" == "127.0.0.1" ]] || \
  [[ "$server" == "$current_hostname" ]]
}

TMESH_CLIENT_CONFIG="
${TMESH_BASE_CONFIG}

# inline a script
bind -n M-s display-popup -E server-select.sh
"

TMESH_SERVER_CONFIG="
${TMESH_BASE_CONFIG}
${TMESH_CLIENT_CONFIG}

set -g prefix C-a
unbind-key C-b
bind-key C-a send-prefix
"

function tryStartTmeshServerSession() {
  # TODO: use local tmux if available
  local escaped_cmd
  escaped_cmd=$(printf '%q' "$CMD")
  
  # Generate session name from parent directory (cleaned of special chars)
  local session_name
  session_name=$(basename "$(dirname "$PWD")" | sed 's/[^a-zA-Z0-9_-]/-/g')
  
  # Find main or master directory for working directory and window name
  local work_dir window_name
  work_dir=$(find . -maxdepth 1 -type d \( -name main -o -name master \) | head -1)
  window_name=${work_dir#./}
  
  # Use current directory if no main/master found
  if [[ -z "$work_dir" ]]; then
    work_dir="."
    window_name="default"
  fi
  
  if isLocalhost "$SERVER"; then
    # Use SSH for localhost connections - create temp config file
    if ! suppress_output ssh "$SERVER" -- bash -c "
      tmpfile=\$(mktemp)
      cat > \"\$tmpfile\" << 'EOF'
$TMESH_SERVER_CONFIG
EOF
      \"$NIX_BIN\" run nixpkgs#tmux -- -f \"\$tmpfile\" -L ${TMESH_SOCKET}-server new-session -s '$session_name' -c '$work_dir' -n '$window_name' -d $escaped_cmd
      rm \"\$tmpfile\"
    "; then
      echo "Error: Failed to start tmesh server session on localhost ($SERVER)" >&2
      return 1
    fi
  else
    # Use mosh for remote connections - create temp config file
    if ! suppress_output mosh "$SERVER" -- bash -c "
      tmpfile=\$(mktemp)
      cat > \"\$tmpfile\" << 'EOF'
$TMESH_SERVER_CONFIG
EOF
      \"$NIX_BIN\" run nixpkgs#tmux -- -f \"\$tmpfile\" -L ${TMESH_SOCKET}-server new-session -s '$session_name' -c '$work_dir' -n '$window_name' -d $escaped_cmd
      rm \"\$tmpfile\"
    "; then
      echo "Error: Failed to start tmesh server session on remote host ($SERVER)" >&2
      return 1
    fi
  fi
}

function tryStartTmeshClientSession() {
  # Generate session name from parent directory (cleaned of special chars)
  local session_name
  session_name=$(basename "$(dirname "$PWD")" | sed 's/[^a-zA-Z0-9_-]/-/g')
  
  # Create temp config file for client
  local tmpfile
  tmpfile=$(mktemp)
  cat > "$tmpfile" << EOF
$TMESH_CLIENT_CONFIG
EOF
  
  if isLocalhost "$SERVER"; then
    # Use SSH for localhost connections
    if ! suppress_output "$NIX_BIN" run nixpkgs#tmux -- \
      -f "$tmpfile" \
      -L "${TMESH_SOCKET}-client" \
      new-session \
      -s "$SERVER" \
      -d \
      ssh "$SERVER" -t "\"$NIX_BIN\" run nixpkgs#tmux -- -L ${TMESH_SOCKET}-server attach-session -t '$session_name'"; then
      echo "Error: Failed to start tmesh client session for localhost ($SERVER)" >&2
      rm "$tmpfile"
      return 1
    fi
  else
    # Use mosh for remote connections
    if ! suppress_output "$NIX_BIN" run nixpkgs#tmux -- \
      -f "$tmpfile" \
      -L "${TMESH_SOCKET}-client" \
      new-session \
      -s "$SERVER" \
      -d \
      mosh "$SERVER" -- "\"$NIX_BIN\" run nixpkgs#tmux -- -L ${TMESH_SOCKET}-server attach-session -t '$session_name'"; then
      echo "Error: Failed to start tmesh client session for remote host ($SERVER)" >&2
      rm "$tmpfile"
      return 1
    fi
  fi
  
  # Clean up temp file
  rm "$tmpfile"
}

tryStartTmesh() {
  # Generate session name from parent directory (cleaned of special chars)
  local session_name
  session_name=$(basename "$(dirname "$PWD")" | sed 's/[^a-zA-Z0-9_-]/-/g')
  
  if ! "$NIX_BIN" run nixpkgs#tmux -- -L "${TMESH_SOCKET}-client" has-session -t "$SERVER" 2>/dev/null; then
    if ! tryStartTmeshServerSession; then
      echo "Error: Failed to start tmesh server session" >&2
      return 1
    fi
    
    if ! tryStartTmeshClientSession; then
      echo "Error: Failed to start tmesh client session" >&2
      return 1
    fi
  fi
}

tryConnectTmux() {
  # TODO: test this command.
  # "$NIX_BIN" run nixpkgs#tmux -- -L "${TMESH_SOCKET}-client" attach-session -d -t "$SERVER"

  if [[ -z "$TMUX" ]]; then
    if ! "$NIX_BIN" run nixpkgs#tmux -- -L "${TMESH_SOCKET}-client" attach-session -t "$SERVER"; then
      echo "Error: Failed to attach to tmux session for server ($SERVER)" >&2
      return 1
    fi
  else
    if ! "$NIX_BIN" run nixpkgs#tmux -- -L "${TMESH_SOCKET}-client" switch-client -t "$SERVER"; then
      echo "Error: Failed to switch to tmux session for server ($SERVER)" >&2
      return 1
    fi
  fi
}

main() {
  if ! tryStartTmesh; then
    echo "Error: Failed to initialize tmesh" >&2
    exit 1
  fi
  
  if ! tryConnectTmux; then
    echo "Error: Failed to connect to tmux session" >&2
    exit 1
  fi
}

main
